import 'package:flutter/material.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';
import 'package:voxai_quest/features/speaking/domain/entities/speaking_quest.dart';
import 'package:voxai_quest/core/utils/speech_service.dart';
import 'package:voxai_quest/core/utils/injection_container.dart';

class SpeakingQuestWidget extends StatefulWidget {
  final SpeakingQuest quest;
  final Function(String) onSubmit;

  const SpeakingQuestWidget({
    super.key,
    required this.quest,
    required this.onSubmit,
  });

  @override
  State<SpeakingQuestWidget> createState() => _SpeakingQuestWidgetState();
}

class _SpeakingQuestWidgetState extends State<SpeakingQuestWidget> {
  final SpeechService _speechService = sl<SpeechService>();
  String _recognizedText = "";
  bool _isListening = false;
  double _accuracy = 0.0;

  void _listen() async {
    if (_isListening) {
      await _speechService.stop();
      setState(() => _isListening = false);
      return;
    }

    bool initialized = await _speechService.initializeStt();
    if (!initialized) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(content: Text('Microphone permission denied')),
      );
      return;
    }

    setState(() {
      _isListening = true;
      _recognizedText = "Listening...";
    });

    _speechService.listen(
      onResult: (text) {
        setState(() {
          _recognizedText = text;
          _calculateAccuracy(text);
        });
      },
      onDone: () {
        setState(() => _isListening = false);
      },
    );
  }

  void _calculateAccuracy(String spoken) {
    // Simple accuracy calculation: compare words
    String target = widget.quest.textToSpeak.toLowerCase().replaceAll(RegExp(r'[^\w\s]'), '');
    String input = spoken.toLowerCase().replaceAll(RegExp(r'[^\w\s]'), '');
    
    if (input.isEmpty) return;

    List<String> targetWords = target.split(' ');
    List<String> inputWords = input.split(' ');
    
    int matches = 0;
    for (var word in inputWords) {
      if (targetWords.contains(word)) {
        matches++;
      }
    }
    
    setState(() {
      _accuracy = matches / targetWords.length;
    });

    // Auto-submit if accuracy is high enough
    if (_accuracy >= 0.8) {
      widget.onSubmit(spoken);
    }
  }

  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        // Instruction and Phrase Card
        Container(
          padding: EdgeInsets.all(24.w),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(24.r),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withValues(alpha: 0.05),
                blurRadius: 20,
                offset: const Offset(0, 10),
              ),
            ],
          ),
          child: Column(
            children: [
              Text(
                'LISTEN & REPEAT',
                style: TextStyle(
                  color: Colors.blue,
                  fontWeight: FontWeight.bold,
                  letterSpacing: 1.2,
                  fontSize: 12.sp,
                ),
              ),
              SizedBox(height: 16.h),
              Text(
                widget.quest.textToSpeak,
                style: TextStyle(
                  fontSize: 24.sp,
                  fontWeight: FontWeight.bold,
                  height: 1.4,
                ),
                textAlign: TextAlign.center,
              ),
              SizedBox(height: 16.h),
              IconButton.filledTonal(
                onPressed: () => _speechService.speak(widget.quest.textToSpeak),
                icon: const Icon(Icons.volume_up_rounded),
                iconSize: 32.r,
              ),
              Text(
                "Tap to hear pronunciation",
                style: TextStyle(color: Colors.grey, fontSize: 12.sp),
              ),
            ],
          ),
        ),
        SizedBox(height: 40.h),
        
        // Recognized Text Display
        if (_recognizedText.isNotEmpty)
          Container(
            padding: EdgeInsets.symmetric(horizontal: 20.w, vertical: 12.h),
            decoration: BoxDecoration(
              color: Colors.blue.withValues(alpha: 0.05),
              borderRadius: BorderRadius.circular(16.r),
            ),
            child: Column(
              children: [
                Text(
                  "You said:",
                  style: TextStyle(color: Colors.grey, fontSize: 12.sp),
                ),
                Text(
                  _recognizedText,
                  style: TextStyle(
                    fontSize: 18.sp,
                    color: Colors.blue[800],
                    fontStyle: FontStyle.italic,
                  ),
                  textAlign: TextAlign.center,
                ),
                if (_accuracy > 0) ...[
                  SizedBox(height: 8.h),
                  LinearProgressIndicator(
                    value: _accuracy,
                    backgroundColor: Colors.blue.withValues(alpha: 0.1),
                    valueColor: AlwaysStoppedAnimation<Color>(
                      _accuracy >= 0.8 ? Colors.green : Colors.orange,
                    ),
                    minHeight: 4.h,
                  ),
                ],
              ],
            ),
          ),
        
        SizedBox(height: 48.h),

        // Record Button
        GestureDetector(
          onTap: _listen,
          child: Stack(
            alignment: Alignment.center,
            children: [
              if (_isListening)
                TweenAnimationBuilder<double>(
                  tween: Tween(begin: 0.0, end: 1.0),
                  duration: const Duration(seconds: 1),
                  builder: (context, value, child) {
                    return Container(
                      width: (100 + 40 * value).r,
                      height: (100 + 40 * value).r,
                      decoration: BoxDecoration(
                        shape: BoxShape.circle,
                        color: Colors.blue.withValues(alpha: 0.2 * (1 - value)),
                      ),
                    );
                  },
                ),
              Container(
                width: 100.r,
                height: 100.r,
                decoration: BoxDecoration(
                  color: _isListening ? Colors.red : Colors.blue,
                  shape: BoxShape.circle,
                  boxShadow: [
                    BoxShadow(
                      color: (_isListening ? Colors.red : Colors.blue).withValues(alpha: 0.4),
                      blurRadius: 20,
                      spreadRadius: 5,
                    ),
                  ],
                ),
                child: Icon(
                  _isListening ? Icons.stop : Icons.mic,
                  color: Colors.white,
                  size: 40.r,
                ),
              ),
            ],
          ),
        ),
        SizedBox(height: 16.h),
        Text(
          _isListening ? "Listening..." : "Tap the mic to start speaking",
          style: TextStyle(
            color: _isListening ? Colors.red : Colors.grey,
            fontWeight: _isListening ? FontWeight.bold : FontWeight.normal,
          ),
        ),

        const Spacer(),
        
        if (_recognizedText.isNotEmpty && !_isListening)
          ElevatedButton(
            onPressed: () => widget.onSubmit(_recognizedText),
            style: ElevatedButton.styleFrom(
              minimumSize: Size(double.infinity, 56.h),
              backgroundColor: _accuracy >= 0.8 ? Colors.green : Colors.blue,
              foregroundColor: Colors.white,
              shape: RoundedRectangleBorder(
                borderRadius: BorderRadius.circular(16.r),
              ),
            ),
            child: const Text('SUBMIT ATTEMPT'),
          ),
      ],
    );
  }

  @override
  void dispose() {
    _speechService.stop();
    super.dispose();
  }
}
